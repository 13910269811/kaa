---
layout: page
title: Cassandra log appender
permalink: /:path/
nav: /:path/Programming-guide/Key-platform-features/Data-collection/Cassandra-log-appender
sort_idx: 10
---

{% assign root_url = page.url | split: '/'%}
{% capture root_url  %} /{{root_url[1]}}/{{root_url[2]}}/{% endcapture %}

* TOC
{:toc}

The Cassandra log appender is responsible for transferring logs from the Operations server to the Cassandra database.

# Creating Cassandra log appender with Admin UI

The easiest way to create a Cassandra log appender for your application is by using Admin UI.

To create a log appender do the following:

1. In the <b>Log appenders</b> window, click <b>Add log appender</b>.
2. Enter the log appender name and description, select the minimum and maximum supported schema version, select necessary log metadata fields.
3. Set the log appender type to <i>Cassandra</i>.
4. Fill in the Cassandra log appender configuration form.
5. Click <b>Add</b>.

<img src="attach/create-cassandra-log-appender-admin-ui.png">

# Creating Cassandra log appender with Admin REST API

It is also possible to create a Cassandra log appender instance by using [Admin REST API]({{root_url}}Programming-guide/Server-REST-APIs #TODO).
The following example illustrates how to provision the Cassandra log appender via Admin REST API.

## Configuration

The Cassandra log appender configuration should match to
[this](https://github.com/kaaproject/kaa/blob/master/server/appenders/cassandra-appender/src/main/avro/cassandra-appender-config.avsc) Avro schema.

* Cassandra nodes - list of Cassandra hosts.
* Authentication credentials - credentials used to authenticate on Cassandra cluster
* Keyspace name – Cassandra keyspace used to prefix the data table
* Table name pattern – pattern used to create table name (ex.: <b>logs_$app_token</b> adds the application token at the end of the table name).
* Column Mapping - section that handles data mapping configuration. It can map specific log data to appropriate columns.

|Type |Example value|Example column type|Description|
|---||---||---||---|
|${TYPE}_BINARY||BLOB|Maps one of the fields listed above in binary format|
|${TYPE}_JSON||TEXT|Maps one of the fields listed above as a corresponding JSON|
|CLIENT_FIELD|clientField|TEXT|Maps a client-side endpoint profile field to the specified column|
|EVENT_FIELD |telemetry|DOUBLE|Maps a log schema field to the specified column|
|HEADER_FIELD|endpointKeyHash, applicationToken, headerVersion,timestamp, logSchemaVersion|TEXT|Maps a header variable to specified the column|
|SERVER_FIELD|serverField|TEXT|Maps a server-side endpoint profile field to the specified column|
|TS|ddMMyy|BIGINT|Maps a timestamp generated by Kaa to the specified field. Timestamp pattern is handled by java.text.SimpleDateFormat|
|UUID|(empty)|UUID|Maps a UUID generated by Kaa to the specified field|

<br/>

Any field can be made a partition and/or clustering key with using correspoding checkboxes.

Key clustering is configured by <b>Clustering</b> section, by adding column names and setting their order (<b>DESC</b> or <b>ASC</b>).

>**NOTE:**  
> Cassandra driver settings can be specified in log appender configuration. Consult the official 
[documentation](http://docs.datastax.com/en/developer/java-driver/3.0/java-driver/whatsNew2.html?local=true&nav=toc) for reference.

The following configuration example matches the previous schema.

```json
{
    "cassandraServers":[
        {
            "host":"127.0.0.1",
            "port":9042
        }
    ],
    "cassandraCredential":{
        "org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraCredential":{
            "user":"user",
            "password":"password"
        }
    },
    "keySpace":"kaa_logs",
    "tableNamePattern":"logs_$app_token_$config_hash",
    "columnMapping":[
        {
            "type":"CLIENT_FIELD",
            "value":{
                "string":"applicationToken"
            },
            "columnName":"application_token",
            "columnType":"BOOLEAN",
            "partitionKey":false,
            "clusteringKey":false
        },
        {
            "type":"SERVER_FIELD",
            "value":{
                "string":"applicationToken"
            },
            "columnName":"application_token",
            "columnType":"BOOLEAN",
            "partitionKey":false,
            "clusteringKey":false
        }
    ],
    "clusteringMapping":[
        {
            "columnName":"application_token",
            "order":"DESC"
        }
    ],
    "cassandraBatchType":{
        "org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraBatchType":"UNLOGGED"
    },
    "cassandraSocketOption":{
        "org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraSocketOption":{
            "sendBufferSize":{
                "int":8192
            },
            "receiveBufferSize":{
                "int":8192
            },
            "soLinger":{
                "int":0
            },
            "connectionTimeout":{
                "int":5000
            },
            "readTimeout":{
                "int":12000
            },
            "reuseAddress":{
                "boolean":false
            },
            "keepAlive":{
                "boolean":false
            },
            "tcpNoDelay":{
                "boolean":false
            }
        }
    },
    "executorThreadPoolSize":1,
    "callbackThreadPoolSize":2,
    "dataTTL":0,
    "cassandraWriteConsistencyLevel":{
        "org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraWriteConsistencyLevel":"ONE"
    },
    "cassandraCompression":{
        "org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraCompression":"NONE"
    },
    "cassandraExecuteRequestType":{
        "org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraExecuteRequestType":"SYNC"
    }
}
```

## Administration

The following Admin REST API call example illustrates how to create an instance of the Cassandra log appender.

```bash
curl -v -S -u devuser:devuser123 -X POST -H 'Content-Type: application/json' -d '{"pluginClassName":"org.kaaproject.kaa.server.appenders.cassandra.appender.CassandraLogAppender", "applicationId":"113", "applicationToken":"08690892651366457342", "jsonConfiguration":"{\"cassandraServers\" : [ { \"host\" : \"127.0.0.1\", \"port\" : 9042   } ],   \"cassandraCredential\" : { \"org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraCredential\" : {   \"user\" : \"user\",   \"password\" : \"password\" }   },   \"keySpace\" : \"kaa_logs\",   \"tableNamePattern\" : \"logs_$app_token_$config_hash\",   \"columnMapping\" : [ { \"type\" : \"CLIENT_FIELD\", \"value\" : {   \"string\" : \"applicationToken\" }, \"columnName\" : \"application_token\", \"columnType\" : \"BOOLEAN\", \"partitionKey\" : false, \"clusteringKey\" : false   }, { \"type\" : \"SERVER_FIELD\", \"value\" : {   \"string\" : \"applicationToken\" }, \"columnName\" : \"application_token\", \"columnType\" : \"BOOLEAN\", \"partitionKey\" : false, \"clusteringKey\" : false   } ],   \"clusteringMapping\" : [ { \"columnName\" : \"application_token\", \"order\" : \"DESC\"   } ],   \"cassandraBatchType\" : { \"org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraBatchType\" : \"UNLOGGED\"   },   \"cassandraSocketOption\" : { \"org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraSocketOption\" : {   \"sendBufferSize\" : { \"int\" : 8192   },   \"receiveBufferSize\" : { \"int\" : 8192   },   \"soLinger\" : { \"int\" : 0   },   \"connectionTimeout\" : { \"int\" : 5000   },   \"readTimeout\" : { \"int\" : 12000   },   \"reuseAddress\" : { \"boolean\" : false   },   \"keepAlive\" : { \"boolean\" : false   },   \"tcpNoDelay\" : { \"boolean\" : false   } }   },   \"executorThreadPoolSize\" : 1,   \"callbackThreadPoolSize\" : 2,   \"dataTTL\" : 0,   \"cassandraWriteConsistencyLevel\" : { \"org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraWriteConsistencyLevel\" : \"ONE\"   },   \"cassandraCompression\" : { \"org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraCompression\" : \"NONE\"   },   \"cassandraExecuteRequestType\" : { \"org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraExecuteRequestType\" : \"SYNC\"   } }", "description":"New sample Cassandra log appender", "headerStructure":["KEYHASH", "TIMESTAMP"], "name":"New Cassandra DB appender", "maxLogSchemaVersion":2147483647, "minLogSchemaVersion":1, "tenantId":"10"}' "http://localhost:8080/kaaAdmin/rest/api/logAppender" | python -mjson.tool
```

Example result:

```json
{
    "applicationId":"113",
    "applicationToken":"99589384065844422599",
    "confirmDelivery":true,
    "createdTime":1426071306494,
    "createdUsername":"devuser",
    "description":"New sample Cassandra log appender",
    "headerStructure":[
        "KEYHASH",
        "TIMESTAMP"
    ],
    "id":"322",
    "jsonConfiguration":"{   \"cassandraServers\" : [ { \"host\" : \"127.0.0.1\", \"port\" : 9042   } ],   \"cassandraCredential\" : { \"org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraCredential\" : {   \"user\" : \"user\",   \"password\" : \"password\" }   },   \"keySpace\" : \"kaa_logs\",   \"tableNamePattern\" : \"logs_$app_token_$config_hash\",   \"columnMapping\" : [ { \"type\" : \"CLIENT_FIELD\", \"value\" : {   \"string\" : \"applicationToken\" }, \"columnName\" : \"application_token\", \"columnType\" : \"BOOLEAN\", \"partitionKey\" : false, \"clusteringKey\" : false   }, { \"type\" : \"SERVER_FIELD\", \"value\" : {   \"string\" : \"applicationToken\" }, \"columnName\" : \"application_token\", \"columnType\" : \"BOOLEAN\", \"partitionKey\" : false, \"clusteringKey\" : false   } ],   \"clusteringMapping\" : [ { \"columnName\" : \"application_token\", \"order\" : \"DESC\"   } ],   \"cassandraBatchType\" : { \"org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraBatchType\" : \"UNLOGGED\"   },   \"cassandraSocketOption\" : { \"org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraSocketOption\" : {   \"sendBufferSize\" : { \"int\" : 8192   },   \"receiveBufferSize\" : { \"int\" : 8192   },   \"soLinger\" : { \"int\" : 0   },   \"connectionTimeout\" : { \"int\" : 5000   },   \"readTimeout\" : { \"int\" : 12000   },   \"reuseAddress\" : { \"boolean\" : false   },   \"keepAlive\" : { \"boolean\" : false   },   \"tcpNoDelay\" : { \"boolean\" : false   } }   },   \"executorThreadPoolSize\" : 1,   \"callbackThreadPoolSize\" : 2,   \"dataTTL\" : 0,   \"cassandraWriteConsistencyLevel\" : { \"org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraWriteConsistencyLevel\" : \"ONE\"   },   \"cassandraCompression\" : { \"org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraCompression\" : \"NONE\"   },   \"cassandraExecuteRequestType\" : { \"org.kaaproject.kaa.server.appenders.cassandra.config.gen.CassandraExecuteRequestType\" : \"SYNC\"   } }",
    "maxLogSchemaVersion":2147483647,
    "minLogSchemaVersion":1,
    "name":"New Cassandra DB appender",
    "pluginClassName":"org.kaaproject.kaa.server.appenders.cassandra.appender.CassandraLogAppender",
    "pluginTypeName":null,
    "tenantId":"70"
}
```

# Playing with Cassandra log appender

We'll use [Data collection demo](https://github.com/kaaproject/sample-apps/tree/master/datacollectiondemo/source) from Kaa Sendbox. Our example will send data 
to Kaa and then persist it to Cassandra. Also, we'll do selection queries on persisted data.

We have next log schema:

```json
{
    "type":"record",
    "name":"LogData",
    "namespace":"org.kaaproject.kaa.schema.sample.logging",
    "fields":[
        {
            "name":"level",
            "type":{
                "type":"enum",
                "name":"Level",
                "symbols":[
                    "KAA_DEBUG",
                    "KAA_ERROR",
                    "KAA_FATAL",
                    "KAA_INFO",
                    "KAA_TRACE",
                    "KAA_WARN"
                ]
            }
        },
        {
            "name":"tag",
            "type":"string"
        },
        {
            "name":"message",
            "type":"string"
        }
    ]
}
```

The following JSON example matches the previous schema.

```json
{
    "level":"KAA_INFO",
    "tag":"TEST_TAG",
    "message":"My simple message"
}
```

Go to Data collection demos in Sandbox.

<img src="attach/data-collection-demo-in-sandbox.png">

Follow <b>Installation</b> instructions.

Next, in the Admin UI follow to <b>Data collection demo</b> application

<img src="attach/data-collection-demo-application.png">

Go to application's <b>Log appenders</b> configuration and add a new one.

<img src="attach/ log-appenders-configuration.png">

Enter name of the new appender (we'll use "Cassandra")

Select <b>Cassandra</b> appender type.

<img src="attach/cassandra-appender-type.png">

Add new node in the <b>Configuration</b> section (localhost:9042)

<img src="attach/configuration-section.png">

Add auth details if needed (for Sandbox it's empty)

Fill keyspace name. "kaa" is used in this example, because it's already created on a Sandbox machine.

"logs_example" is used as the <b>Table name pattern</b>.

The important part of configuration is <b>Column Mapping</b>:

<img src="attach/column-mapping.png" width="75%" height="75%" />

Other configuration:

<img src="attach/other-configuration.png">

Now click <b>Add</b> button on the top of the screen to create and deploy appender.

<img src="attach/add-button.png">

Verify that newly created appender has appeared in list.

<img src="attach/verify-created-appender.png">

Now run Data collection demo application. Verify that logs have been successfully sent to Kaa

<img src="attach/run-data-collection-demo-application.png">

Let's verify that our logs have been persisted in Cassandra. Go to Sandbox VM and run next command to connect Cassandra:

```bash
~$ cqlsh
```

Then

```bash
cqlsh> SELECT * FROM kaa.logs_example
```

You should observe similar output:

```bash
id                                    | application_token    | level_field | tag_field | message_field
--------------------------------------+----------------------+-------------+-----------+---------------
 a7195d60-58f6-437e-ab26-c1d0c6926fda | 87799423522715447243 |    KAA_INFO |       TAG |     MESSAGE_4
 98f9aab5-cc78-4dd4-8a64-aa740382d5f6 | 87799423522715447243 |    KAA_INFO |       TAG |     MESSAGE_0
 21c940a0-41c4-48e3-9f1e-00c986af4061 | 87799423522715447243 |    KAA_INFO |       TAG |     MESSAGE_1
 7ab1ed65-c18b-4b00-a5e3-7bab16fd2e6a | 87799423522715447243 |    KAA_INFO |       TAG |     MESSAGE_2
 310191f3-673c-4998-ae94-323f04fb1ba9 | 87799423522715447243 |    KAA_INFO |       TAG |     MESSAGE_3
```
 
If your output doesn't match above one, please follow our [troubleshooting guide]({{root_url}}Administration-guide/Troubleshooting).